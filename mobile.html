<script type="module">
  window.EventEmitter = class EventEmitter {
    constructor() {
      this.callbacks = {}
    }

    on(event, cb) {
      if (!this.callbacks[event]) this.callbacks[event] = [];
      this.callbacks[event].push(cb)
    }

    emit(event, data) {
      let cbs = this.callbacks[event]
      if (cbs) {
        cbs.forEach(cb => cb(data))
      }
    }
  }
  class CloudlinkJS {
    constructor(server) {
      var ws = new WebSocket(server);
      var events = new EventEmitter()
      this.events = events
      this.ws = ws

      ws.onopen = function () {
        events.emit('opened');
      };

      ws.onmessage = function (e) {
        let data = JSON.parse(e.data)
        if (data.cmd === 'ds') ws.close();
        events.emit('data', data);
      }

      ws.onclose = function () {
        events.emit('closed');
      };

      ws.onerror = function (e) {
        events.emit('error', e);
      };
    }
      send(data) {
        this.ws.send(JSON.stringify(data))
      }
      on(event, cb) {
        return this.events.on(event, cb);
      }
      disconnect() {
        this.ws.close()
      }
  }
  var url = 'wss://server.meower.org'
  var cljs = new CloudlinkJS(url);
  var posts = [];
  var gotten_posts = {};
  window.cljs = cljs;
  cljs.on("data", (data) => {
    if (data.val.mode == "auth") {
      var username = data.val.payload.username
      cljs.send({cmd: "setid", val: username});
      cljs.send({cmd: "direct", id: "", val: {cmd: "get_profile", val: username}});
      cljs.send({cmd: "direct", id: "", val: {cmd: "get_home", val: ""}});
      console.log(String(JSON.stringify({cmd: "internal", val: "authed"})));
    };
    if (data.val.mode == "home") {
      posts = data.val.payload.split(";");
      if (posts.length < 1) {
        console.log(String(JSON.stringify({cmd: "internal", val: "I: posts_downloaded"})));
      }
      for (var i in posts) {
        if (posts[i] != "") {
          if (localStorage.getItem(posts[i]) == null) {
            cljs.send({cmd: "direct", id: "", val: {cmd: "get_post", val: posts[i]}});
          } else {
            gotten_posts[posts[i]] = localStorage.getItem(posts[i]);
            if (Object.keys(gotten_posts).length == posts.length-1) {
              for (var i in posts) {
                if (posts[i] != ""){
                  console.log(String(JSON.stringify({cmd: "new_post", val: gotten_posts[posts[i]]})));
                }
              }
              console.log(String(JSON.stringify({cmd: "internal", val: "I: posts_downloaded"})));
            }
          }
        }
      }
    }
    if (data.val.mode == "profile") {
      console.log(String(JSON.stringify({cmd: "theme", val: data.val.payload.user_settings.theme})));
      console.log(String(JSON.stringify({cmd: "debug", val: data.val.payload.user_settings.debug})));
      console.log(String(JSON.stringify({cmd: "pfp", val: data.val.payload.user_data.pfp_data})));
    }
    if (data.val.mode == "post") {
      gotten_posts[data.val.payload.post_id] = data.val.payload;
      localStorage.setItem(data.val.payload.post_id, String(JSON.stringify(gotten_posts[data.val.payload.post_id])));
      if (Object.keys(gotten_posts).length == posts.length-1) {
        for (var i in posts) {
          if (posts[i] != ""){
            console.log(String(JSON.stringify({cmd: "new_post", val: gotten_posts[posts[i]]})));
          }
        }
        console.log(String(JSON.stringify({cmd: "internal", val: "I: posts_downloaded"})));
      }
    }
    console.log(String(JSON.stringify(data)));
  });
  cljs.on("opened", () => {
    console.log(String(JSON.stringify({cmd: "internal", val: "I: connected"})));
  });
  cljs.on("closed", () => {
    console.log(String(JSON.stringify({cmd: "internal", val: "I: disconnected"})));
  });
</script>
<script>
  function ping() {
    cljs.send({cmd: "direct", id: "", val: {cmd: "ping", val: ""}});
  };
  function login(ip, trust, u, p) {
    cljs.send({cmd:"direct",val:{cmd:"type",val:"mobile"}});
    cljs.send({cmd: "direct", val: {cmd: "ip", val: ip}});
    cljs.send({cmd: "direct", id: "", val: trust});
    cljs.send({cmd:"direct", id: "", val:{cmd:"authpswd",val:{username: u, pswd: p}}});
  };
  function create_acc() {
    cljs.send({cmd: "setid", val: '{{username}}'});
    cljs.send({cmd:"direct", id: "", val:{cmd:"gen_account",val: '{{password}}'}});
    cljs.send({cmd:"direct", id: "", val:{cmd:"authpswd",val:{username: '{{username}}', pswd: '{{password}}'}}});
    setTimeout(function(){
      console.log(String(JSON.stringify({cmd: "internal", val: "created_acc"})));
    }, 2000);
  };
  function refresh_home() {
    cljs.send({cmd: "direct", id: "", val: {cmd: "get_home", val: ""}});
  };
  function new_post() {
    text = prompt("New Post");
    if (text != null) {
      cljs.send({cmd: "direct", id: "", val: {cmd: "post_home", val: text}});
    }
  };
</script>